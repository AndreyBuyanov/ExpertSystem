#   Input variables:
#       PUGIXML_GIT_TAG
#       PUGIXML_BUILD_DIR
#       PUGIXML_INSTALL_DIR

cmake_minimum_required (VERSION 3.0)

project(pugixmlBuild)

include(ExternalProject)

if(MSVC AND NOT (${CMAKE_GENERATOR} MATCHES "Win64"))
    set(PUGIXML_CMAKE_GENERATOR_PLATFORM -A ${CMAKE_GENERATOR_PLATFORM})
else()
    set(PUGIXML_CMAKE_GENERATOR_PLATFORM)
endif()

set(PUGIXML_GIT_REPOSITORY https://github.com/zeux/pugixml.git)

set(PUGIXML_CONFIGURE_OPTIONS
	-DUSE_POSTFIX=ON
	-DCMAKE_INSTALL_PREFIX=${PUGIXML_INSTALL_DIR}
    -G ${CMAKE_GENERATOR}
    ${PUGIXML_CMAKE_GENERATOR_PLATFORM}
)

set(PUGIXML_BUILD_DIR_DEBUG ${PUGIXML_BUILD_DIR}/Debug)
set(PUGIXML_BUILD_DIR_RELWITHDEBINFO ${PUGIXML_BUILD_DIR}/RelWithDebInfo)
file(MAKE_DIRECTORY ${PUGIXML_BUILD_DIR_DEBUG})
file(MAKE_DIRECTORY ${PUGIXML_BUILD_DIR_RELWITHDEBINFO})
set(PUGIXML_CONFIGURE_COMMAND ${CMAKE_COMMAND} ${PUGIXML_CONFIGURE_OPTIONS})
set(PUGIXML_BUILD_COMMAND_DEBUG ${CMAKE_COMMAND} --build ${PUGIXML_BUILD_DIR_DEBUG} --config Debug)
set(PUGIXML_BUILD_COMMAND_RELWITHDEBINFO ${CMAKE_COMMAND} --build ${PUGIXML_BUILD_DIR_RELWITHDEBINFO} --config RelWithDebInfo)
set(PUGIXML_INSTALL_COMMAND_DEBUG ${CMAKE_COMMAND} --build ${PUGIXML_BUILD_DIR_DEBUG} --config Debug --target install)
set(PUGIXML_INSTALL_COMMAND_RELWITHDEBINFO ${CMAKE_COMMAND} --build ${PUGIXML_BUILD_DIR_RELWITHDEBINFO} --config RelWithDebInfo --target install)

ExternalProject_Add(
    pugixml
    GIT_REPOSITORY ${PUGIXML_GIT_REPOSITORY}
    GIT_TAG ${PUGIXML_GIT_TAG}
    CONFIGURE_COMMAND ${PUGIXML_CONFIGURE_COMMAND} -S . -B ${PUGIXML_BUILD_DIR_DEBUG} && ${PUGIXML_CONFIGURE_COMMAND} -S . -B ${PUGIXML_BUILD_DIR_RELWITHDEBINFO}
    BUILD_COMMAND ${PUGIXML_BUILD_COMMAND_DEBUG} && ${PUGIXML_BUILD_COMMAND_RELWITHDEBINFO}
    BUILD_IN_SOURCE 1
    INSTALL_COMMAND ${PUGIXML_INSTALL_COMMAND_DEBUG} && ${PUGIXML_INSTALL_COMMAND_RELWITHDEBINFO}
)
